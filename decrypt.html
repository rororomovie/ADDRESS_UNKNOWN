<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>address unknown</title>

<style>
  body{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                 "Liberation Mono","Courier New", monospace;
    padding:18px;
    line-height:1.9;
    background:#fff;
    color:#000;
  }
  pre{ white-space: pre-wrap; margin:0; }
  .muted{ opacity:.7; }
  .row{ margin-top:10px; }
  input, button{
    font: inherit;
    padding: 6px 10px;
    border: 1px solid #000;
    background:#fff;
  }
  button{ cursor:pointer; }
</style>

<h1>address unknown</h1>
<pre class="muted">宛名を知っているなら、書いてください。</pre>

<pre id="msg" class="muted"></pre>

<div class="row">
  <input
    id="keyInput"
    placeholder="ADRESS_UNKNOWN"
    autocomplete="off"
    spellcheck="false"
  >
</div>

<div class="row">
  <button id="postBtn">投函する</button>
</div>

<script>
async function sha256(bytes){
  const h = await crypto.subtle.digest("SHA-256", bytes);
  return new Uint8Array(h);
}
function b64ToU8(b64){
  const bin = atob(b64);
  const u8 = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
  return u8;
}

async function tryDecryptFromHash(){
  const msg = document.getElementById("msg");
  const keyStr = decodeURIComponent(location.hash.slice(1) || "");

  if(!keyStr){
    msg.textContent = "……宛名が見当たりません。";
    return;
  }

  const res = await fetch("final.enc.json", { cache:"no-store" });
  if(!res.ok){
    msg.textContent = "undelivered";
    return;
  }
  const pack = await res.json();

  try{
    const keyBytes = await sha256(new TextEncoder().encode(keyStr));
    const aesKey = await crypto.subtle.importKey(
      "raw",
      keyBytes,
      { name:"AES-GCM" },
      false,
      ["decrypt"]
    );

    const iv = b64ToU8(pack.iv_b64);
    const ct = b64ToU8(pack.ct_b64);

    const plainBuf = await crypto.subtle.decrypt(
      { name:"AES-GCM", iv },
      aesKey,
      ct
    );

    // ===== 成功 =====
    document.body.innerHTML = "";
    const pre = document.createElement("pre");
    pre.textContent = new TextDecoder().decode(plainBuf);
    document.body.appendChild(pre);

  }catch(e){
    msg.textContent = "……宛名が違います。";
  }
}

// 投函ボタン：hashを書き換えて再ロード
document.getElementById("postBtn").addEventListener("click", () => {
  const v = document.getElementById("keyInput").value.trim();
  if(!v){
    document.getElementById("msg").textContent = "……宛名が空です。";
    return;
  }
  location.hash = encodeURIComponent(v);
  location.reload();
});

// Enterキーでも投函
document.getElementById("keyInput").addEventListener("keydown", e => {
  if(e.key === "Enter"){
    document.getElementById("postBtn").click();
  }
});

// 起動時：hashがあれば復号を試す
if(location.hash){
  document.getElementById("keyInput").value =
    decodeURIComponent(location.hash.slice(1));
  tryDecryptFromHash();
}
</script>

