<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>address unknown</title>

<style>
  body{
    font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,
                 "Liberation Mono","Courier New",monospace;
    padding:16px;
    line-height:1.7;
    background:#fff;
    color:#000;
  }
  pre{
    white-space:pre-wrap;
    word-break:break-word;
    margin:0;
  }
  .muted{opacity:.7}
</style>

<h1 id="title">address unknown</h1>
<p id="hint" class="muted">鍵は URL の <code>#</code> の後ろに入れてください。</p>
<pre id="out">loading...</pre>

<script>
async function sha256(bytes){
  const h = await crypto.subtle.digest("SHA-256", bytes);
  return new Uint8Array(h);
}
function b64ToU8(b64){
  const bin = atob(b64);
  const u8 = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
  return u8;
}

(async () => {
  const out   = document.getElementById("out");
  const title = document.getElementById("title");
  const hint  = document.getElementById("hint");

  const keyStr = decodeURIComponent(location.hash.slice(1) || "");
  if(!keyStr){
    out.textContent = "……宛名が見当たりません。";
    return;
  }

  const res = await fetch("final.enc.json", {cache:"no-store"});
  if(!res.ok){
    out.textContent = "undelivered";
    return;
  }
  const pack = await res.json();

  const keyBytes = await sha256(new TextEncoder().encode(keyStr));
  const aesKey = await crypto.subtle.importKey(
    "raw",
    keyBytes,
    {name:"AES-GCM"},
    false,
    ["decrypt"]
  );

  try{
    const iv = b64ToU8(pack.iv_b64);
    const ct = b64ToU8(pack.ct_b64);

    const plainBuf = await crypto.subtle.decrypt(
      {name:"AES-GCM", iv},
      aesKey,
      ct
    );

    // ===== 復号成功 =====
    // 余計なUIを消す
    title.remove();
    hint.remove();

    // 本文だけ表示
    out.textContent = new TextDecoder().decode(plainBuf);

  }catch(e){
    out.textContent = "……鍵が違います。";
  }
})();
</script>
