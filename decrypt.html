<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>address unknown</title>

<style>
  body{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                 "Liberation Mono","Courier New", monospace;
    padding:18px;
    line-height:1.9;
    background:#fff;
    color:#000;
  }
  pre{
    white-space:pre-wrap;
    margin:0;
  }
  input, button{
    font: inherit;
    padding: 6px 10px;
    margin-top: 10px;
    border: 1px solid #000;
    background: #fff;
  }
  button{ cursor:pointer; }
  .muted{ opacity:.7; }
</style>

<h1 id="title">address unknown</h1>

<pre id="hint" class="muted">
宛名を知っているなら、書いてください。
</pre>

<input
  id="keyInput"
  placeholder="宛名"
  autocomplete="off"
  spellcheck="false"
/>
<br>
<button id="openBtn">投函する</button>

<pre id="out" class="muted"></pre>

<script>
async function sha256(bytes){
  const h = await crypto.subtle.digest("SHA-256", bytes);
  return new Uint8Array(h);
}
function b64ToU8(b64){
  const bin = atob(b64);
  const u8 = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
  return u8;
}

async function tryDecrypt(keyStr){
  const out = document.getElementById("out");

  if(!keyStr){
    out.textContent = "……宛名が見当たりません。";
    return;
  }

  const res = await fetch("final.enc.json", { cache: "no-store" });
  if(!res.ok){
    out.textContent = "undelivered";
    return;
  }
  const pack = await res.json();

  try{
    const keyBytes = await sha256(new TextEncoder().encode(keyStr));
    const aesKey = await crypto.subtle.importKey(
      "raw",
      keyBytes,
      { name:"AES-GCM" },
      false,
      ["decrypt"]
    );

    const iv = b64ToU8(pack.iv_b64);
    const ct = b64ToU8(pack.ct_b64);

    const plainBuf = await crypto.subtle.decrypt(
      { name:"AES-GCM", iv },
      aesKey,
      ct
    );

    // ===== 復号成功 =====
    document.body.innerHTML = "";
    const pre = document.createElement("pre");
    pre.textContent = new TextDecoder().decode(plainBuf);
    document.body.appendChild(pre);

  }catch(e){
    out.textContent = "……宛名が違います。";
  }
}

// ボタン
document.getElementById("openBtn").addEventListener("click", () => {
  tryDecrypt(document.getElementById("keyInput").value.trim());
});

// Enterキー
document.getElementById("keyInput").addEventListener("keydown", e => {
  if(e.key === "Enter"){
    tryDecrypt(e.target.value.trim());
  }
});

// URLの # に鍵がある場合は自動入力
const hashKey = decodeURIComponent(location.hash.slice(1) || "");
if(hashKey){
  document.getElementById("keyInput").value = hashKey;
  tryDecrypt(hashKey);
}
</script>
